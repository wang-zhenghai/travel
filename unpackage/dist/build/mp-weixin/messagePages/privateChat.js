(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["messagePages/privateChat"],{"78b0":function(e,i,o){},c21d:function(e,i,o){"use strict";(function(e){var n=o("4ea4");Object.defineProperty(i,"__esModule",{value:!0}),i.default=void 0;var s=n(o("90cb")),t=o("5e97"),a=n(o("0ded")),r=new a.default,l=e.$GoEasy,g=e.$GRTC,c={name:"privateChat",data:function(){var e="https://imgcache.qq.com/open/qcloud/tim/assets/emoji/",i={"[NO]":"emoji_0@2x.png","[OK]":"emoji_1@2x.png","[下雨]":"emoji_2@2x.png","[么么哒]":"emoji_3@2x.png","[乒乓]":"emoji_4@2x.png","[便便]":"emoji_5@2x.png","[信封]":"emoji_6@2x.png","[偷笑]":"emoji_7@2x.png","[傲慢]":"emoji_8@2x.png","[再见]":"emoji_9@2x.png","[冷汗]":"emoji_10@2x.png","[凋谢]":"emoji_11@2x.png","[刀]":"emoji_12@2x.png","[删除]":"emoji_13@2x.png","[勾引]":"emoji_14@2x.png","[发呆]":"emoji_15@2x.png","[发抖]":"emoji_16@2x.png","[可怜]":"emoji_17@2x.png","[可爱]":"emoji_18@2x.png","[右哼哼]":"emoji_19@2x.png","[右太极]":"emoji_20@2x.png","[右车头]":"emoji_21@2x.png","[吐]":"emoji_22@2x.png","[吓]":"emoji_23@2x.png","[咒骂]":"emoji_24@2x.png","[咖啡]":"emoji_25@2x.png","[啤酒]":"emoji_26@2x.png","[嘘]":"emoji_27@2x.png","[回头]":"emoji_28@2x.png","[困]":"emoji_29@2x.png","[坏笑]":"emoji_30@2x.png","[多云]":"emoji_31@2x.png","[大兵]":"emoji_32@2x.png","[大哭]":"emoji_33@2x.png","[太阳]":"emoji_34@2x.png","[奋斗]":"emoji_35@2x.png","[奶瓶]":"emoji_36@2x.png","[委屈]":"emoji_37@2x.png","[害羞]":"emoji_38@2x.png","[尴尬]":"emoji_39@2x.png","[左哼哼]":"emoji_40@2x.png","[左太极]":"emoji_41@2x.png","[左车头]":"emoji_42@2x.png","[差劲]":"emoji_43@2x.png","[弱]":"emoji_44@2x.png","[强]":"emoji_45@2x.png","[彩带]":"emoji_46@2x.png","[彩球]":"emoji_47@2x.png","[得意]":"emoji_48@2x.png","[微笑]":"emoji_49@2x.png","[心碎了]":"emoji_50@2x.png","[快哭了]":"emoji_51@2x.png","[怄火]":"emoji_52@2x.png","[怒]":"emoji_53@2x.png","[惊恐]":"emoji_54@2x.png","[惊讶]":"emoji_55@2x.png","[憨笑]":"emoji_56@2x.png","[手枪]":"emoji_57@2x.png","[打哈欠]":"emoji_58@2x.png","[抓狂]":"emoji_59@2x.png","[折磨]":"emoji_60@2x.png","[抠鼻]":"emoji_61@2x.png","[抱抱]":"emoji_62@2x.png","[抱拳]":"emoji_63@2x.png","[拳头]":"emoji_64@2x.png","[挥手]":"emoji_65@2x.png","[握手]":"emoji_66@2x.png","[撇嘴]":"emoji_67@2x.png","[擦汗]":"emoji_68@2x.png","[敲打]":"emoji_69@2x.png","[晕]":"emoji_70@2x.png","[月亮]":"emoji_71@2x.png","[棒棒糖]":"emoji_72@2x.png","[汽车]":"emoji_73@2x.png","[沙发]":"emoji_74@2x.png","[流汗]":"emoji_75@2x.png","[流泪]":"emoji_76@2x.png","[激动]":"emoji_77@2x.png","[灯泡]":"emoji_78@2x.png","[炸弹]":"emoji_79@2x.png","[熊猫]":"emoji_80@2x.png","[爆筋]":"emoji_81@2x.png","[爱你]":"emoji_82@2x.png","[爱心]":"emoji_83@2x.png","[爱情]":"emoji_84@2x.png","[猪头]":"emoji_85@2x.png","[猫咪]":"emoji_86@2x.png","[献吻]":"emoji_87@2x.png","[玫瑰]":"emoji_88@2x.png","[瓢虫]":"emoji_89@2x.png","[疑问]":"emoji_90@2x.png","[白眼]":"emoji_91@2x.png","[皮球]":"emoji_92@2x.png","[睡觉]":"emoji_93@2x.png","[磕头]":"emoji_94@2x.png","[示爱]":"emoji_95@2x.png","[礼品袋]":"emoji_96@2x.png","[礼物]":"emoji_97@2x.png","[篮球]":"emoji_98@2x.png","[米饭]":"emoji_99@2x.png","[糗大了]":"emoji_100@2x.png","[红双喜]":"emoji_101@2x.png","[红灯笼]":"emoji_102@2x.png","[纸巾]":"emoji_103@2x.png","[胜利]":"emoji_104@2x.png","[色]":"emoji_105@2x.png","[药]":"emoji_106@2x.png","[菜刀]":"emoji_107@2x.png","[蛋糕]":"emoji_108@2x.png","[蜡烛]":"emoji_109@2x.png","[街舞]":"emoji_110@2x.png","[衰]":"emoji_111@2x.png","[西瓜]":"emoji_112@2x.png","[调皮]":"emoji_113@2x.png","[象棋]":"emoji_114@2x.png","[跳绳]":"emoji_115@2x.png","[跳跳]":"emoji_116@2x.png","[车厢]":"emoji_117@2x.png","[转圈]":"emoji_118@2x.png","[鄙视]":"emoji_119@2x.png","[酷]":"emoji_120@2x.png","[钞票]":"emoji_121@2x.png","[钻戒]":"emoji_122@2x.png","[闪电]":"emoji_123@2x.png","[闭嘴]":"emoji_124@2x.png","[闹钟]":"emoji_125@2x.png","[阴险]":"emoji_126@2x.png","[难过]":"emoji_127@2x.png","[雨伞]":"emoji_128@2x.png","[青蛙]":"emoji_129@2x.png","[面条]":"emoji_130@2x.png","[鞭炮]":"emoji_131@2x.png","[风车]":"emoji_132@2x.png","[飞吻]":"emoji_133@2x.png","[飞机]":"emoji_134@2x.png","[饥饿]":"emoji_135@2x.png","[香蕉]":"emoji_136@2x.png","[骷髅]":"emoji_137@2x.png","[麦克风]":"emoji_138@2x.png","[麻将]":"emoji_139@2x.png","[鼓掌]":"emoji_140@2x.png","[龇牙]":"emoji_141@2x.png"};return{targetUsername:"",text:"",friend:{id:"",name:"",avatar:""},to:{},currentUser:null,emoji:{url:e,map:i,visible:!1,decoder:new s.default(e,i)},otherTypesMessagePanelVisible:!1,orderList:{orders:[],visible:!1},history:{messages:[],allLoaded:!1,loading:!1},recorderManager:r,audio:{visible:!1},audioPlayer:{innerAudioContext:null,playingMessage:null},videoPlayer:{visible:!1,url:"",context:null},actionPopup:{visible:!1,message:null,recallable:!1},messageSelector:{visible:!1,messages:[]}}},onLoad:function(i){this.friend.id=i.to,this.friend.name=i.username,this.friend.avatar=i.avatar,this.currentUser=e.getStorageSync("currentUser"),this.targetUsername=this.friend.name,this.to={id:this.friend.id,type:l.IM_SCENE.PRIVATE,data:{name:this.friend.name,avatar:this.friend.avatar}},this.initGoEasyListeners(),this.initialAudioPlayer(),this.initRecorderListeners()},onShow:function(){this.otherTypesMessagePanelVisible=!1,this.emoji.visible=!1},onReady:function(){this.loadHistoryMessage(!0),this.videoPlayer.context=e.createVideoContext("videoPlayer",this),e.setNavigationBarTitle({title:this.friend.name})},onPullDownRefresh:function(e){this.loadHistoryMessage(!1)},onUnload:function(){l.im.off(l.IM_EVENT.PRIVATE_MESSAGE_RECEIVED,this.onMessageReceived),l.im.off(l.IM_EVENT.MESSAGE_DELETED,this.onMessageDeleted)},methods:{renderTextMessage:function(e){return"<span>"+this.emoji.decoder.decode(e.payload.text)+"</span>"},renderMessageDate:function(e,i){return 0===i||e.timestamp-this.history.messages[i-1].timestamp>3e5?(0,t.formatDate)(e.timestamp):""},initGoEasyListeners:function(){l.im.on(l.IM_EVENT.PRIVATE_MESSAGE_RECEIVED,this.onMessageReceived),l.im.on(l.IM_EVENT.MESSAGE_DELETED,this.onMessageDeleted)},onMessageReceived:function(e){var i=e.senderId,o=e.receiverId,n=this.currentUser.userId===i?o:i;n===this.friend.id&&(this.history.messages.push(e),this.markPrivateMessageAsRead(),this.scrollToBottom())},onMessageDeleted:function(e){var i=this;e.forEach((function(e){var o=e.senderId,n=e.receiverId,s=i.currentUser.userId===o?n:o;if(s===i.friend.id){var t=i.history.messages.indexOf(e);t>-1&&i.history.messages.splice(t,1)}}))},initialAudioPlayer:function(){var i=this;this.audioPlayer.innerAudioContext=e.createInnerAudioContext(),this.audioPlayer.innerAudioContext.onEnded((function(){i.audioPlayer.playingMessage=null})),this.audioPlayer.innerAudioContext.onStop((function(){i.audioPlayer.playingMessage=null}))},initRecorderListeners:function(){var i=this;r.onRecordComplete((function(o,n){n<1e3?e.showToast({icon:"none",title:"录音时间太短",duration:500}):l.im.createAudioMessage({to:i.to,file:o,notification:{title:i.currentUser.username+"发来一段语音",body:"[语音消息]",sound:"message",badge:"+1"},onProgress:function(e){console.log(e)},onSuccess:function(e){i.sendMessage(e)},onFailed:function(e){console.log("error :",e)}})}))},getImageHeight:function(e,i){return e<200&&i<150?2*i:e>i?200/e*i*2:e===i||e<i?300:void 0},sendMessage:function(e){this.history.messages.push(e),this.scrollToBottom(),l.im.sendMessage({message:e,onSuccess:function(e){console.log("发送成功.",e)},onFailed:function(e){507===e.code?console.log("发送语音/图片/视频/文件失败，没有配置OSS存储，详情参考：https://docs.goeasy.io/2.x/im/message/media/alioss"):console.log("发送失败:",e)}})},sendTextMessage:function(){var e=this;if(""!==this.text.trim()){var i=this.text;this.text.length>=200&&(i=this.text.substring(0,190)+"..."),l.im.createTextMessage({text:this.text,to:this.to,notification:{title:this.currentUser.username+"发来一段文字",body:i,sound:"message",badge:"+1"},onSuccess:function(i){e.sendMessage(i)},onFailed:function(e){console.log("error :",e)}})}this.text=""},sendVideoMessage:function(){var i=this;e.chooseVideo({success:function(e){l.im.createVideoMessage({to:i.to,file:e,notification:{title:i.currentUser.username+"发来一个视频",body:"[视频消息]",sound:"message",badge:"+1"},onProgress:function(e){console.log(e)},onSuccess:function(e){i.otherTypesMessagePanelVisible=!1,i.sendMessage(e)},onFailed:function(e){console.log("error :",e)}})}})},sendImageMessage:function(){var i=this;e.chooseImage({count:9,success:function(e){e.tempFiles.forEach((function(e){l.im.createImageMessage({to:i.to,file:e,notification:{title:i.currentUser.username+"发来一张图片",body:"[图片消息]",sound:"message",badge:"+1"},onProgress:function(e){console.log(e)},onSuccess:function(e){i.otherTypesMessagePanelVisible=!1,i.sendMessage(e)},onFailed:function(e){console.log("error :",e)}})}))}})},showActionPopup:function(e){this.messageSelector.messages=[e],Date.now()-e.timestamp<18e4&&e.senderId===this.currentUser.userId&&"success"===e.status?this.actionPopup.recallable=!0:this.actionPopup.recallable=!1,this.actionPopup.visible=!0},hideActionPopup:function(){this.actionPopup.visible=!1,this.actionPopup.message=null},deleteSingleMessage:function(){var i=this;e.showModal({content:"确认删除？",success:function(e){i.actionPopup.visible=!1,e.confirm&&i.deleteMessage()}})},deleteMultipleMessages:function(){var i=this;this.messageSelector.messages.length>0&&e.showModal({content:"确认删除？",success:function(e){i.messageSelector.visible=!1,e.confirm&&i.deleteMessage()}})},deleteMessage:function(){var e=this;l.im.deleteMessage({messages:this.messageSelector.messages,onSuccess:function(i){e.messageSelector.messages.forEach((function(i){var o=e.history.messages.indexOf(i);o>-1&&e.history.messages.splice(o,1)})),e.messageSelector.messages=[]},onFailed:function(e){console.log("error:",e)}})},recallMessage:function(){this.actionPopup.visible=!1,l.im.recallMessage({messages:this.messageSelector.messages,onSuccess:function(){console.log("撤回成功")},onFailed:function(e){console.log("撤回失败,error:",e)}})},editRecalledMessage:function(e){this.audio.visible&&(this.audio.visible=!1),this.text=e},showCheckBox:function(){this.messageSelector.messages=[],this.messageSelector.visible=!0,this.actionPopup.visible=!1},selectMessages:function(e){var i=e.detail.value,o=[];this.history.messages.forEach((function(e){i.includes(e.messageId)&&o.push(e)})),this.messageSelector.messages=o},loadHistoryMessage:function(i){var o=this;this.history.loading=!0;var n=null,s=this.history.messages[0];s&&(n=s.timestamp),l.im.history({userId:this.friend.id,lastTimestamp:n,limit:10,onSuccess:function(s){e.stopPullDownRefresh(),o.history.loading=!1;var t=s.content;0===t.length?o.history.allLoaded=!0:(o.history.messages=n?t.concat(o.history.messages):t,t.length<10&&(o.history.allLoaded=!0),i&&(o.scrollToBottom(),o.markPrivateMessageAsRead()))},onFailed:function(i){console.log("获取历史消息失败:",i),e.stopPullDownRefresh(),o.history.loading=!1}})},switchAudioKeyboard:function(){this.audio.visible=!this.audio.visible,this.audio.visible&&r.authorize().then((function(){console.log("录音权限获取成功")})).catch((function(i){console.log("err:",i),e.showModal({title:"获取录音权限失败",content:i})}))},onRecordStart:function(){r.start()},onRecordEnd:function(){r.stop()},showImageFullScreen:function(i){var o=[i.currentTarget.dataset.url];e.previewImage({urls:o})},playVideo:function(e){var i=this;this.videoPlayer.visible=!0,this.videoPlayer.url=e.currentTarget.dataset.url,this.$nextTick((function(){i.videoPlayer.context.requestFullScreen({direction:0}),i.videoPlayer.context.play()}))},playAudio:function(e){var i=this.audioPlayer.playingMessage;i&&(this.audioPlayer.innerAudioContext.stop(),i===e)||(this.audioPlayer.playingMessage=e,this.audioPlayer.innerAudioContext.src=e.payload.url,this.audioPlayer.innerAudioContext.play())},onVideoFullScreenChange:function(e){this.videoPlayer.visible&&!e.detail.fullScreen&&(this.videoPlayer.visible=!1,this.videoPlayer.context.stop())},messageInputFocusin:function(){this.otherTypesMessagePanelVisible=!1,this.emoji.visible=!1},switchEmojiKeyboard:function(){this.emoji.visible=!this.emoji.visible,this.otherTypesMessagePanelVisible=!1},showOtherTypesMessagePanel:function(){this.otherTypesMessagePanelVisible=!this.otherTypesMessagePanelVisible,this.emoji.visible=!1},chooseEmoji:function(e){this.text+=e},privateCall:function(){var i=this;e.showActionSheet({itemList:["视频通话","音频通话"],success:function(o){var n=0===o.tapIndex?1:0,s=0===o.tapIndex?"邀请你视频通话":"邀请你语音通话";g.call({calleeId:i.friend.id,mediaType:n,notification:{title:i.currentUser.username,body:s,sound:"ring",badge:"+1"}}).then((function(){e.navigateTo({url:"./rtc/private/dial"})})).catch((function(i){console.log("呼叫失败:",i),e.showToast({icon:"error",title:"呼叫失败:"+i,duration:2e3})}))},fail:function(e){console.log(e.errMsg)}})},scrollToBottom:function(){this.$nextTick((function(){e.pageScrollTo({scrollTop:2e6,duration:0})}))},markPrivateMessageAsRead:function(){l.im.markMessageAsRead({id:this.to.id,type:this.to.type,onSuccess:function(){console.log("标记私聊已读成功")},onFailed:function(e){console.log("标记私聊已读失败",e)}})}}};i.default=c}).call(this,o("543d")["default"])},c62e:function(e,i,o){"use strict";var n=o("78b0"),s=o.n(n);s.a},c673:function(e,i,o){"use strict";o.d(i,"b",(function(){return s})),o.d(i,"c",(function(){return t})),o.d(i,"a",(function(){return n}));var n={tnNavBar:function(){return Promise.all([o.e("common/vendor"),o.e("tuniao-ui/components/tn-nav-bar/tn-nav-bar")]).then(o.bind(null,"aa86"))}},s=function(){var e=this,i=e.$createElement,o=(e._self._c,e.__map(e.history.messages,(function(i,o){var n=e.__get_orig(i),s=e.renderMessageDate(i,o),t=i.recalled?e.currentUser.userId.toString():null,a=i.recalled&&i.recaller.id===t?"text"===i.type&&Date.now()-i.timestamp<6e4:null,r=i.recalled?null:e.messageSelector.messages.includes(i),l=i.recalled?null:e.currentUser.userId.toString(),g=i.recalled?null:e.currentUser.userId.toString(),c=i.recalled||"text"!==i.type?null:e.renderTextMessage(i),m=i.recalled||"video"!==i.type?null:e.getImageHeight(i.payload.thumbnail.width,i.payload.thumbnail.height),u=i.recalled||"file"!==i.type?null:(i.payload.size/1024).toFixed(2),d=i.recalled||"audio"!==i.type?null:Math.ceil(i.payload.duration),p=i.recalled||"audio"!==i.type?null:Math.ceil(i.payload.duration)||1,h=i.recalled?null:e.currentUser.userId.toString();return{$orig:n,m0:s,g0:t,g1:a,g2:r,g3:l,g4:g,m1:c,m2:m,g5:u,g6:d,g7:p,g8:h}}))),n=e.videoPlayer.visible||e.messageSelector.visible||!e.emoji.visible?null:e.__map(e.emoji.map,(function(i,o,n){var s=e.__get_orig(i);return{$orig:s,$index:n}}));e.$mp.data=Object.assign({},{$root:{l0:o,l1:n}})},t=[]},d431:function(e,i,o){"use strict";(function(e,i){var n=o("4ea4");o("1827");n(o("66fd"));var s=n(o("fa0a"));e.__webpack_require_UNI_MP_PLUGIN__=o,i(s.default)}).call(this,o("bc2e")["default"],o("543d")["createPage"])},d4c5:function(e,i,o){"use strict";o.r(i);var n=o("c21d"),s=o.n(n);for(var t in n)["default"].indexOf(t)<0&&function(e){o.d(i,e,(function(){return n[e]}))}(t);i["default"]=s.a},fa0a:function(e,i,o){"use strict";o.r(i);var n=o("c673"),s=o("d4c5");for(var t in s)["default"].indexOf(t)<0&&function(e){o.d(i,e,(function(){return s[e]}))}(t);o("c62e");var a=o("f0c5"),r=Object(a["a"])(s["default"],n["b"],n["c"],!1,null,null,null,!1,n["a"],void 0);i["default"]=r.exports}},[["d431","common/runtime","common/vendor"]]]);